<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Augment - Bugment é…ç½®</title>
  <script nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    /**
     * Monaco bootstrap script
     *
     * This script is included directly in HTML files to load Monaco editor.
     * It's kept as a simple JS file to avoid any build/transpilation requirements.
     */

    // Define the Monaco CDN version
    const MONACO_VERSION = "0.52.2";
    const MONACO_CDN_BASE = `https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/${MONACO_VERSION}/min`;

    // Initialize augmentDeps if it doesn't exist
    window.augmentDeps = window.augmentDeps || {};

    // Create a promise that will resolve when Monaco is ready
    let monacoResolve;
    window.augmentDeps.monaco = new Promise((resolve) => {
      monacoResolve = resolve;
    });

    // If Monaco is already loaded, don't load it again
    if (window.monaco) {
      console.log("Monaco already loaded, skipping bootstrap");
      initializeMonacoDeps();
    } else {
      // Load the Monaco loader script
      const loaderScript = document.createElement("script");
      loaderScript.src = `${MONACO_CDN_BASE}/vs/loader.min.js`;
      loaderScript.onload = initializeMonaco;
      document.head.appendChild(loaderScript);
    }

    // Initialize Monaco after the loader script has loaded
    function initializeMonaco() {
      // require is provided by loader.min.js
      require.config({
        paths: { vs: `${MONACO_CDN_BASE}/vs` },
      });

      require(["vs/editor/editor.main"], () => {
        initializeMonacoDeps();
      });
    }

    // Initialize Monaco dependencies
    function initializeMonacoDeps() {
      window.augmentDeps.monaco.resolve = monacoResolve;
      monacoResolve(window.monaco);
    }

  </script>
  <meta property="csp-nonce" nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
  <style nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    /* Global Reset & Typography */
    :root {
      --radius-base: 4px;
      --spacing-base: 16px;
    }

    body {
      font-family: var(--vscode-font-family, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif);
      font-size: var(--vscode-font-size, 13px);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      margin: 0;
      padding: 24px;
      line-height: 1.4;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Modern Header */
    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 24px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .header-icon {
      font-size: 36px;
      line-height: 1;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .header-content {
      display: flex;
      flex-direction: column;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
      letter-spacing: -0.2px;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* Modern Card */
    .card {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-widget-border);
      border-radius: var(--radius-base);
      padding: 0;
      overflow: hidden;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-color: var(--vscode-focusBorder);
    }

    .card-header {
      padding: 16px 20px;
      background-color: var(--vscode-editor-lineHighlightBackground);
      border-bottom: 1px solid var(--vscode-widget-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--vscode-foreground);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Support direct h2 in card without .card-header wrapper */
    .card > h2 {
        padding: 16px 20px;
        background-color: var(--vscode-editor-lineHighlightBackground);
        border-bottom: 1px solid var(--vscode-widget-border);
    }

    .config-section, .content-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Form Elements */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-input-foreground);
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      padding: 6px 10px;
      font-family: var(--vscode-font-family);
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.15s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    ::placeholder {
        color: var(--vscode-input-placeholderForeground);
    }

    /* Buttons */
    .button {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      border-radius: 2px;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      height: 28px;
      box-sizing: border-box;
    }

    .button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .button.secondary {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .button.secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .button.small {
      padding: 0 10px;
      height: 24px;
      font-size: 12px;
    }

    .button-group {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    /* Status & Info */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row .label {
      color: var(--vscode-descriptionForeground);
      font-size: 13px;
    }

    .info-row .value {
        font-weight: 500;
        font-family: var(--vscode-editor-font-family, monospace);
        font-size: 13px;
    }

    .config-status {
      padding: 8px 12px;
      border-radius: 2px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 20px;
      margin-top: 8px;
    }

    .config-status:empty {
        display: none;
    }

    .config-status.success { color: var(--vscode-testing-iconPassed); background-color: rgba(0,255,0,0.1); }
    .config-status.error { color: var(--vscode-errorForeground); background-color: rgba(255,0,0,0.1); }
    .config-status.warning { color: var(--vscode-editorWarning-foreground); background-color: rgba(255,200,0,0.1); }

    .activation-status { font-weight: 600; }
    .activation-status.activated { color: var(--vscode-testing-iconPassed); }
    .activation-status.pending { color: var(--vscode-descriptionForeground); }
    .activation-status.expired { color: var(--vscode-editorWarning-foreground); }
    .activation-status.not-activated { color: var(--vscode-errorForeground); }

    /* Utility Helpers */
    .input-with-button { display: flex; gap: 8px; }
    .input-with-button input { flex: 1; }

    .input-hint {
        margin-top: 8px;
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        line-height: 1.4;
        display: flex;
        align-items: flex-start;
        gap: 6px;
    }

    .hidden { display: none !important; }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* Activation Textarea */
    #activation-code-input {
      font-family: var(--vscode-editor-font-family, 'SF Mono', Monaco, Consolas, monospace);
      font-size: 12px;
      line-height: 1.5;
      min-height: 120px;
      resize: vertical;
      white-space: pre-wrap;
    }
    /* Augment Balance Styles */
    .balance-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px 20px 20px 20px;
    }

    .balance-amount {
      font-size: 24px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .balance-amount.positive {
      color: var(--vscode-testing-iconPassed);
    }

    .balance-amount.low {
      color: var(--vscode-editorWarning-foreground);
    }

    .balance-amount.negative {
      color: var(--vscode-errorForeground);
    }

    .balance-status {
      font-size: 14px;
      color: var(--vscode-descriptionForeground);
    }

    .account-info {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 12px 20px 20px 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- {{ AURA: Modify - éšè—æ ‡é¢˜åŒºåŸŸï¼Œç®€åŒ–ç•Œé¢ }} -->
    <div class="header" style="display:none;">
      <div class="header-icon">ğŸš€</div>
      <div class="header-content">
        <h1>Bugment Control Center</h1>
        <div class="header-subtitle">Manage your models, activation, and settings</div>
      </div>
    </div>

    <div class="content">
      <!-- æ¨¡å‹é…ç½®å¡ç‰‡ -->
      <div class="card" id="model-config-card">
        <!-- {{ AURA: Modify - éšè—å¡ç‰‡å¤´éƒ¨ }} -->
        <div class="card-header" style="display:none;">
          <h2>ğŸ¤– æ¨¡å‹é…ç½®</h2>
          <button class="button small" onclick="refreshModelConfig()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="config-section">
          <!-- {{ AURA: Modify - éšè— Provider/Base URL æ˜¾ç¤ºï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼ }} -->
          <!-- å½“å‰é…ç½®æ˜¾ç¤º - éšè— -->
          <div class="info-row" style="display:none;">
            <span class="label">å½“å‰ Provider:</span>
            <span class="value" id="current-provider">Kiro</span>
          </div>
          <div class="info-row" style="display:none;">
            <span class="label">å½“å‰æ¨¡å‹:</span>
            <span class="value" id="current-model">-</span>
          </div>
          <!-- Base URL éšè—ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼ -->
          <div class="input-group" style="display:none;">
            <label for="base-url-input">Base URL:</label>
            <input type="text" id="base-url-input" value="https://newapi.stonefancyx.com" placeholder="e.g. http://127.0.0.1:8317">
          </div>

          <!-- API Key è¾“å…¥æ¡† - ä¿ç•™æ˜¾ç¤º -->
          <div class="input-group">
            <label for="api-key-input">API Key:</label>
            <div class="input-with-button">
              <input type="password" id="api-key-input" placeholder="sk-..." value="">
              <button id="toggle-api-key" class="button secondary small" onclick="toggleApiKeyVisibility()">ğŸ‘ï¸</button>
            </div>
          </div>



          <!-- {{ AURA: Modify - Provider é€‰æ‹©å™¨éšè—ï¼Œç¡¬ç¼–ç ä¸º Kiro }} -->
          <div class="input-group" style="display:none;">
            <label for="provider-select">é€‰æ‹© Provider:</label>
            <select id="provider-select">
              <option value="Kiro" selected>Kiro</option>
            </select>
          </div>

          <!-- Model é€‰æ‹©å™¨ - ä¿ç•™æ˜¾ç¤ºï¼Œä½¿ç”¨ç®€åŒ–åç§° -->
          <div class="input-group">
            <label for="model-select">é€‰æ‹©æ¨¡å‹:</label>
            <select id="model-select">
              <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
              <option value="kiro-claude-opus-4-5-agentic" selected>Claude Opus 4.5</option>
              <option value="kiro-claude-sonnet-4-5-agentic">Sonnet 4.5</option>
              <option value="kiro-claude-sonnet-4-agentic">Sonnet 4</option>
              <option value="kiro-claude-haiku-4-5-agentic">Haiku 4.5</option>
            </select>
          </div>

          <div class="button-group">
            <button class="button" onclick="applyModelConfig()">åº”ç”¨é…ç½®</button>
          </div>
          <div class="config-status" id="model-config-status"></div>
        </div>
      </div>

      <!-- {{ AURA: Modify - ç³»ç»Ÿæ¿€æ´»å¡ç‰‡éšè— }} -->
      <div class="card" id="activation-card" style="display:none;">
        <h2>ğŸ” ç³»ç»Ÿæ¿€æ´»</h2>
        <div class="config-section">
          <div class="info-row">
            <span class="label">æ¿€æ´»çŠ¶æ€:</span>
            <span class="value" id="activation-status">
              <span class="loading">â³ æ£€æŸ¥ä¸­...</span>
            </span>
          </div>
          <div class="info-row">
            <span class="label">æœºå™¨ID:</span>
            <span class="value" id="machine-id">-</span>
            <button class="copy-button" onclick="copyMachineId()" title="å¤åˆ¶æœºå™¨ID">ğŸ“‹ å¤åˆ¶</button>
          </div>
          <div class="info-row" id="activation-date-row" style="display: none;">
            <span class="label">æ¿€æ´»æ—¶é—´:</span>
            <span class="value" id="activation-date">-</span>
          </div>

          <div id="activation-input-section" style="display: none;">
            <div class="input-group">
              <label for="activation-code-input">ç­¾åæ¿€æ´»ç  (JWS):</label>
              <textarea id="activation-code-input"
                placeholder="ç²˜è´´ä»¥ . åˆ†éš”çš„ç­¾åæ¿€æ´»ç  (JWS)&#10;&#10;ç¤ºä¾‹æ ¼å¼ï¼š&#10;eyJhbGciOiJFZERTQSIsImtpZCI6Im1haW4ifQ.&#10;eyJzdWIiOiJWSVAtRDlGRi05ODdGLThGNEUiLCJpYXQiOjE3NTc2MDk1NzUsImV4cCI6MTc2MDIwMTU3NSwianRpIjoiNjc1NjBjOTktOTNmOS00YjBkLWJjMWMtNWE2MjgxNzZkNGE4IiwicGtoIjoiODNwSk1pREZIaTRqbGRlbFJWT2o1MlJVX1piZFNjcGJZcm9KNUJZYzJ6OCIsImVkaXRpb24iOiJWSVAifQ.&#10;7ueSdpTmLr5nL0-rXXbmg5HNh9crCY2Ss6Dqu3OxBqQgqltovsuIiH_OmOV03izvotPGR5QTc2Lr4QeSqQg1DA"
                rows="6"></textarea>
              <div class="input-hint">
                <span>ğŸ’¡</span>
                <span><strong>æç¤ºï¼š</strong>æ¿€æ´»ç å¾ˆé•¿ï¼Œå¯ä»¥ç›´æ¥ç²˜è´´æ•´ä¸ªJWSä»¤ç‰Œã€‚æ”¯æŒæ¢è¡Œæ˜¾ç¤ºï¼Œæ–¹ä¾¿æŸ¥çœ‹å„ä¸ªéƒ¨åˆ†ã€‚</span>
              </div>
            </div>
            <div class="button-group">
              <button class="button" onclick="activateSystem()">æ¿€æ´»ç³»ç»Ÿ</button>
              <button class="button secondary" onclick="clearActivationInput()">æ¸…ç©º</button>
            </div>
          </div>

          <div id="activation-success-section" style="display: none;">
            <div class="button-group">
              <button class="button secondary small" onclick="copyMachineId()">å¤åˆ¶æœºå™¨ID</button>
            </div>
          </div>

          <div class="config-status" id="activation-status-message"></div>
        </div>
      </div>

      <!-- ä¿¡æ¯é¢æ¿ - æ‰€æœ‰ç‰ˆæœ¬å¯ç”¨ -->
      <div class="card" id="info-panel-card" style="display: none;">
        <h2>ğŸš€ Augment ä¿¡æ¯é¢æ¿</h2>
        <p>è¿™ä¸ªé¢æ¿æ˜¾ç¤ºæ‚¨çš„ Augment Code è´¦å·ä¿¡æ¯å’Œä½¿ç”¨ç§¯åˆ†çŠ¶æ€ã€‚</p>

        <div class="config-section">
          <div class="info-row">
            <span class="label">æ‰©å±•ç‰ˆæœ¬:</span>
            <span class="value" id="extension-version">æœªçŸ¥</span>
          </div>
          <div class="info-row">
            <span class="label">å®‰è£…æ—¶é—´:</span>
            <span class="value" id="install-time">æœªçŸ¥</span>
          </div>
        </div>
      </div>

      <div class="card" id="token-config-card" style="display: none;">
        <h2>âš™ï¸ Orb Token é…ç½®</h2>
        <div class="config-section">
          <div class="input-group">
            <label for="api-token-input">Orb Token:</label>
            <div class="input-with-button">
              <input type="password" id="api-token-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ Augment Orb Token" />
              <button class="button small" onclick="toggleTokenVisibility()">ğŸ‘ï¸</button>
            </div>
          </div>
          <div class="button-group">
            <button class="button" onclick="saveToken()">ä¿å­˜é…ç½®</button>
            <button class="button secondary" onclick="testToken()">æµ‹è¯•è¿æ¥</button>
            <button class="button secondary" onclick="openSettings()">æ‰“å¼€è®¾ç½®</button>
          </div>
          <div class="config-status" id="config-status"></div>
        </div>
      </div>

      <!-- {{ AURA: Add - å¥—é¤ä¿¡æ¯å¡ç‰‡ï¼Œæ˜¾ç¤ºå½“å‰ä½™é¢å’Œè¿‡æœŸæ—¶é—´ }} -->
      <div class="card" id="quota-info-card">
        <div class="card-header">
          <h2>ğŸ’³ å¥—é¤ä¿¡æ¯</h2>
          <button class="button small" onclick="refreshQuotaInfo()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="config-section">
          <div class="info-row">
            <span class="label">å½“å‰ä½™é¢:</span>
            <span class="value" id="quota-available"><span class="loading">â³ åŠ è½½ä¸­...</span></span>
          </div>

          <div class="info-row">
            <span class="label">è¿‡æœŸæ—¶é—´:</span>
            <span class="value" id="quota-expires">-</span>
          </div>
          <div class="config-status" id="quota-status"></div>
        </div>
      </div>

      <div class="card" id="balance-card" style="display: none;">
        <div class="card-header">
          <h2>ğŸ‘¤ è´¦å·ä¿¡æ¯</h2>
          <button class="button small" onclick="refreshBalance()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="account-info">
          <div class="info-row">
            <span class="label">å½“å‰ç§¯åˆ†:</span>
            <span class="value" id="balance-amount"><span class="loading">â³ åŠ è½½ä¸­...</span></span>
          </div>
          <div class="info-row" id="balance-status-row" style="display: none;">
            <span class="label">ç§¯åˆ†çŠ¶æ€:</span>
            <span class="value" id="balance-status"></span>
          </div>
          <div class="info-row">
            <span class="label">é‚®ç®±è´¦å·:</span>
            <span class="value" id="account-email">-</span>
          </div>
          <div class="info-row">
            <span class="label">å¥—é¤åç§°:</span>
            <span class="value" id="account-plan">-</span>
          </div>
          <div class="info-row">
            <span class="label">åˆ°æœŸæ—¶é—´:</span>
            <span class="value" id="account-expiry">-</span>
          </div>
        </div>
      </div>

      <!-- æ¨¡å‹é…ç½®å¡ç‰‡ (å·²ç§»åŠ¨åˆ°é¡¶éƒ¨) -->


      <div class="card" style="display: none;">
        <h2>åŠŸèƒ½ç‰¹æ€§</h2>
        <p>æ­¤é¢æ¿æ”¯æŒä¸ VSCode æ’ä»¶çš„åŒå‘é€šä¿¡ï¼Œå¯ä»¥å®ç°å¤æ‚çš„äº¤äº’åŠŸèƒ½ã€‚</p>

        <div class="info-section">
          <div class="info-item">
            <h3>ğŸ“Š æ•°æ®å±•ç¤º</h3>
            <span>æ”¯æŒå„ç§æ•°æ®å¯è§†åŒ–ç»„ä»¶</span>
          </div>

          <div class="info-item">
            <h3>âš™ï¸ é…ç½®ç®¡ç†</h3>
            <span>ç®¡ç†æ’ä»¶è®¾ç½®å’Œç”¨æˆ·åå¥½</span>
          </div>

          <div class="info-item">
            <h3>ğŸ”§ å·¥å…·é›†æˆ</h3>
            <span>é›†æˆå„ç§å¼€å‘å·¥å…·å’ŒæœåŠ¡</span>
          </div>

          <div class="info-item">
            <h3>ğŸ“ å†…å®¹ç¼–è¾‘</h3>
            <span>æ”¯æŒå¯Œæ–‡æœ¬å’Œä»£ç ç¼–è¾‘</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    // VSCode API
    const vscode = acquireVsCodeApi();

    function showMessage() {
      vscode.postMessage({
        command: 'showMessage',
        text: 'æ¥è‡ªè‡ªå®šä¹‰é¢æ¿çš„æ¶ˆæ¯ï¼'
      });
    }

    function refreshBalance() {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('balance-amount').innerHTML = '<span class="loading">â³ åˆ·æ–°ä¸­...</span>';
      document.getElementById('balance-status').textContent = '';
      document.getElementById('balance-status-row').style.display = 'none';

      // è¯·æ±‚ç§¯åˆ†ä¿¡æ¯
      vscode.postMessage({
        command: 'refreshBalance'
      });
    }

    function updateBalanceDisplay(balance, status) {
      const balanceElement = document.getElementById('balance-amount');
      const statusElement = document.getElementById('balance-status');
      const statusRowElement = document.getElementById('balance-status-row');

      if (balance !== null && balance !== undefined) {
        const balanceValue = parseFloat(balance);
        balanceElement.textContent = `${balanceValue} ç§¯åˆ†`;

        // æ ¹æ®å‰©ä½™ç§¯åˆ†è®¾ç½®é¢œè‰²
        balanceElement.className = 'value';
        if (balanceValue > 100) {
          balanceElement.style.color = 'var(--vscode-testing-iconPassed)';
        } else if (balanceValue > 0) {
          balanceElement.style.color = 'var(--vscode-editorWarning-foreground)';
        } else {
          balanceElement.style.color = 'var(--vscode-errorForeground)';
        }

        // æ˜¾ç¤ºçŠ¶æ€è¡Œï¼ˆå¦‚æœæœ‰çŠ¶æ€ä¿¡æ¯ï¼‰
        if (status) {
          statusElement.textContent = status;
          statusRowElement.style.display = 'flex';
        } else {
          statusRowElement.style.display = 'none';
        }
      } else {
        balanceElement.innerHTML = '<span class="error">è·å–å¤±è´¥</span>';
        statusElement.textContent = status || 'æ— æ³•è·å–ç§¯åˆ†ä¿¡æ¯';
        statusRowElement.style.display = 'flex';
      }
    }

    function updateAccountDisplay(accountInfo) {
      if (accountInfo) {
        document.getElementById('account-email').textContent = accountInfo.email || '-';
        document.getElementById('account-plan').textContent = accountInfo.plan_name || '-';

        if (accountInfo.end_date) {
          const endDate = new Date(accountInfo.end_date);
          document.getElementById('account-expiry').textContent = endDate.toLocaleDateString();
        } else {
          document.getElementById('account-expiry').textContent = 'æ°¸ä¹…æœ‰æ•ˆ';
        }
      }
    }

    function openSettings() {
      vscode.postMessage({
        command: 'openSettings'
      });
    }

    function toggleTokenVisibility() {
      const input = document.getElementById('api-token-input');
      const button = event.target;

      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        button.textContent = 'ğŸ‘ï¸';
      }
    }

    function saveToken() {
      const token = document.getElementById('api-token-input').value.trim();
      const statusDiv = document.getElementById('config-status');

      if (!token) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·è¾“å…¥ Orb Token';
        return;
      }

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ ä¿å­˜ä¸­...';

      vscode.postMessage({
        command: 'saveToken',
        token: token
      });
    }

    function testToken() {
      const token = document.getElementById('api-token-input').value.trim();
      const statusDiv = document.getElementById('config-status');

      if (!token) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·å…ˆè¾“å…¥ Orb Token';
        return;
      }

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ æµ‹è¯•è¿æ¥ä¸­...';

      vscode.postMessage({
        command: 'testToken',
        token: token
      });
    }

    function loadCurrentToken() {
      vscode.postMessage({
        command: 'getCurrentToken'
      });
    }

    // æ¿€æ´»ç›¸å…³åŠŸèƒ½
    function refreshActivationStatus() {
      console.log('[PANEL] ğŸ”„ refreshActivationStatus è¢«è°ƒç”¨');
      console.log('[PANEL] è®¾ç½®çŠ¶æ€ä¸º"æ£€æŸ¥ä¸­..."');
      document.getElementById('activation-status').innerHTML = '<span class="loading">â³ æ£€æŸ¥ä¸­...</span>';

      console.log('[PANEL] å‘é€ getActivationStatus æ¶ˆæ¯åˆ°åç«¯');
      vscode.postMessage({
        command: 'getActivationStatus'
      });
      console.log('[PANEL] âœ… getActivationStatus æ¶ˆæ¯å·²å‘é€');
    }





    function activateSystem() {
      const activationCodeRaw = document.getElementById('activation-code-input').value;
      const statusDiv = document.getElementById('activation-status-message');

      if (!activationCodeRaw) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·è¾“å…¥æ¿€æ´»ç ';
        return;
      }

      // æ¸…ç†æ¿€æ´»ç ï¼šç§»é™¤æ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰ï¼Œåªä¿ç•™JWSå†…å®¹
      const activationCode = activationCodeRaw
        .replace(/\s+/g, '') // ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
        .replace(/[\r\n]/g, '') // ç§»é™¤æ¢è¡Œç¬¦
        .trim();

      if (!activationCode) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ æ¿€æ´»ç ä¸èƒ½ä¸ºç©º';
        return;
      }

      // éªŒè¯ JWS åŸºæœ¬æ ¼å¼ï¼šä¸‰æ®µ Base64URLï¼Œç”¨ç‚¹å·åˆ†éš”
      if (!/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/.test(activationCode)) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºç­¾åæ¿€æ´»ç  (ä¸‰æ®µä»¥ç‚¹åˆ†éš”çš„ JWS)';
        return;
      }

      // æ˜¾ç¤ºæ¸…ç†åçš„æ¿€æ´»ç é•¿åº¦ä¿¡æ¯
      const parts = activationCode.split('.');
      console.log(`[PANEL] æ¿€æ´»ç éªŒè¯é€šè¿‡: Header(${parts[0].length}) + Payload(${parts[1].length}) + Signature(${parts[2].length}) = ${activationCode.length} å­—ç¬¦`);

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ æ¿€æ´»ä¸­...';

      vscode.postMessage({
        command: 'activateSystem',
        activationCode: activationCode
      });
    }

    function clearActivationInput() {
      document.getElementById('activation-code-input').value = '';
      const statusDiv = document.getElementById('activation-status-message');
      statusDiv.className = 'config-status';
      statusDiv.textContent = '';
      console.log('[PANEL] æ¿€æ´»ç è¾“å…¥æ¡†å·²æ¸…ç©º');
    }

    function copyMachineId() {
      const machineId = document.getElementById('machine-id').textContent;
      if (machineId && machineId !== '-') {
        navigator.clipboard.writeText(machineId).then(() => {
          const statusDiv = document.getElementById('activation-status-message');
          statusDiv.className = 'config-status success';
          statusDiv.textContent = 'âœ… æœºå™¨IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
          setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'config-status';
          }, 3000);
        }).catch(() => {
          // é™çº§æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬
          const element = document.getElementById('machine-id');
          const range = document.createRange();
          range.selectNode(element);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
        });
      }
    }

    function updateActivationDisplay(activationInfo) {
      const statusElement = document.getElementById('activation-status');
      const machineIdElement = document.getElementById('machine-id');
      const activationDateRow = document.getElementById('activation-date-row');
      const activationDateElement = document.getElementById('activation-date');
      const inputSection = document.getElementById('activation-input-section');
      const successSection = document.getElementById('activation-success-section');

      // æ›´æ–°æœºå™¨ID
      if (activationInfo.machineId) {
        machineIdElement.innerHTML = `<span class="machine-id">${activationInfo.machineId}</span>`;
      }

      // ä½¿ç”¨æ–°çš„ activationStatus å­—æ®µæ¥åˆ¤æ–­çŠ¶æ€
      const status = activationInfo.activationStatus || (activationInfo.isActivated ? STATUS_STRINGS.ACTIVATED : STATUS_STRINGS.NOT_ACTIVATED);

      if (status === STATUS_STRINGS.ACTIVATED) {
        // å·²æ¿€æ´»çŠ¶æ€ - æ˜¾ç¤ºæ¿€æ´»ä¿¡æ¯ï¼ŒåŒæ—¶å…è®¸é‡æ–°æ¿€æ´»
        statusElement.innerHTML = '<span class="activation-status activated">âœ… å·²æ¿€æ´» (å¯é‡æ–°æ¿€æ´»)</span>';
        inputSection.style.display = 'block'; // ä»ç„¶æ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤æ¿€æ´»
        successSection.style.display = 'block'; // æ˜¾ç¤ºå·²æ¿€æ´»çš„æ“ä½œæŒ‰é’®

        // ä¿®æ”¹æŒ‰é’®æ–‡å­—ä¸ºâ€œé‡æ–°æ¿€æ´»â€
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'é‡æ–°æ¿€æ´»';
        }

        if (activationInfo.activationDate) {
          activationDateRow.style.display = 'flex';
          const date = new Date(activationInfo.activationDate);
          activationDateElement.textContent = date.toLocaleString();
        }

        // åœæ­¢å®šæ—¶æ›´æ–°ï¼ˆå·²æ¿€æ´»çŠ¶æ€ä¸éœ€è¦ç›‘æ§ï¼‰
        stopStatusTimer();
      } else if (status === STATUS_STRINGS.PENDING) {
        // å¾…æ¿€æ´»çŠ¶æ€ï¼ˆå®‰è£…å10åˆ†é’Ÿå†…ï¼‰
        statusElement.innerHTML = '<span class="activation-status pending">â³ å¾…æ¿€æ´»</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // æŒ‰é’®æ–‡å­—ä¸º"æ¿€æ´»ç³»ç»Ÿ"
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'æ¿€æ´»ç³»ç»Ÿ';
        }

        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆå¾…æ¿€æ´»çŠ¶æ€éœ€è¦ç›‘æ§è¯•ç”¨æœŸåˆ°æœŸï¼‰
        startStatusTimer();
      } else if (status === STATUS_STRINGS.EXPIRED) {
        // å·²è¿‡æœŸçŠ¶æ€ï¼ˆæ™®é€šç‰ˆæœ¬2å¤©åˆ°æœŸï¼‰
        statusElement.innerHTML = '<span class="activation-status expired">â° å·²è¿‡æœŸ (éœ€é‡æ–°æ¿€æ´»)</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // æŒ‰é’®æ–‡å­—ä¸º"é‡æ–°æ¿€æ´»"
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'é‡æ–°æ¿€æ´»';
        }

        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆè¿‡æœŸçŠ¶æ€éœ€è¦ç›‘æ§é‡æ–°æ¿€æ´»ï¼‰
        startStatusTimer();
      } else {
        // æœªæ¿€æ´»çŠ¶æ€
        statusElement.innerHTML = '<span class="activation-status not-activated">âŒ æœªæ¿€æ´»</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // é‡ç½®æŒ‰é’®æ–‡å­—ä¸ºâ€œæ¿€æ´»ç³»ç»Ÿâ€
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'æ¿€æ´»ç³»ç»Ÿ';
        }

        // åœæ­¢å®šæ—¶æ›´æ–°ï¼ˆæœªæ¿€æ´»çŠ¶æ€ä¸éœ€è¦ç›‘æ§ï¼‰
        stopStatusTimer();
      }
    }

    // ç›‘å¬æ¥è‡ªæ’ä»¶çš„æ¶ˆæ¯
    window.addEventListener('message', event => {
      const message = event.data;
      switch (message.command) {
        case 'updateBalance':
          updateBalanceDisplay(message.balance, message.status);
          break;
        case 'updateAccount':
          updateAccountDisplay(message.accountInfo);
          break;
        case 'balanceError':
          updateBalanceDisplay(null, message.error);
          break;
        case 'tokenSaved':
          const statusDiv = document.getElementById('config-status');
          if (message.success) {
            statusDiv.className = 'config-status success';
            statusDiv.textContent = 'âœ… Orb Token ä¿å­˜æˆåŠŸ';
            // è‡ªåŠ¨åˆ·æ–°ç§¯åˆ†
            setTimeout(() => {
              refreshBalance();
            }, 1000);
          } else {
            statusDiv.className = 'config-status error';
            statusDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + (message.error || 'æœªçŸ¥é”™è¯¯');
          }
          break;
        case 'tokenTested':
          const testStatusDiv = document.getElementById('config-status');
          if (message.success) {
            testStatusDiv.className = 'config-status success';
            testStatusDiv.textContent = 'âœ… è¿æ¥æµ‹è¯•æˆåŠŸ';
          } else {
            testStatusDiv.className = 'config-status error';
            testStatusDiv.textContent = 'âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + (message.error || 'æœªçŸ¥é”™è¯¯');
          }
          break;
        case 'currentToken':
          if (message.token) {
            document.getElementById('api-token-input').value = message.token;
          }
          break;
        case 'activationStatus':
          updateActivationDisplay(message.activationInfo);
          break;
        case 'activationResult':
          const activationStatusDiv = document.getElementById('activation-status-message');
          if (message.success) {
            activationStatusDiv.className = 'config-status success';
            activationStatusDiv.textContent = 'ğŸ‰ ' + message.message;
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('activation-code-input').value = '';
            // åˆ·æ–°æ¿€æ´»çŠ¶æ€
            setTimeout(() => {
              refreshActivationStatus();
            }, 1000);
          } else {
            activationStatusDiv.className = 'config-status error';
            activationStatusDiv.textContent = 'âŒ ' + message.message;
          }
          break;
        case 'extensionInfo':
          console.log(`[PANEL] æ‰©å±•ä¿¡æ¯: ${message.displayName}, ç‰ˆæœ¬: ${message.version}`);

          // æ›´æ–°æ‰©å±•ç‰ˆæœ¬æ˜¾ç¤º
          document.getElementById('extension-version').textContent = message.version || 'æœªçŸ¥';

          // ç›´æ¥è¯»å–å½“å‰æ’ä»¶çš„package.jsonè·å–å®‰è£…æ—¶é—´
          loadInstallTimeFromPackageJson();

          // æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤ºå®Œæ•´åŠŸèƒ½ï¼Œä¸å†åŒºåˆ†VIP
          toggleVipFeatures(true);

          // åŠ è½½æ‰€æœ‰åŠŸèƒ½
          loadCurrentToken();
          refreshBalance();
          // {{ AURA: Add - åŠ è½½å¥—é¤ä¿¡æ¯ }}
          refreshQuotaInfo();

          // {{ AURA: Modify - åªæ˜¾ç¤º balance-cardï¼Œéšè—å…¶ä»–é¢æ¿ }}
          // document.getElementById('info-panel-card').style.display = 'block';
          // document.getElementById('token-config-card').style.display = 'block';
          document.getElementById('balance-card').style.display = 'block';
          break;
        case 'installTimeFromPackageJson':
          // æ›´æ–°å®‰è£…æ—¶é—´æ˜¾ç¤º
          if (message.installTime) {
            const installDate = new Date(message.installTime).toLocaleString();
            document.getElementById('install-time').textContent = installDate;
            console.log(`[PANEL] ä»package.jsonè·å–å®‰è£…æ—¶é—´: ${installDate}`);
          } else {
            document.getElementById('install-time').textContent = 'æœªçŸ¥';
            console.log(`[PANEL] æ— æ³•ä»package.jsonè·å–å®‰è£…æ—¶é—´`);
          }
          break;
        case 'modelConfigLoaded':
          // æ¨¡å‹é…ç½®åŠ è½½å®Œæˆ
          console.log('[PANEL] æ”¶åˆ°æ¨¡å‹é…ç½®:', message);
          if (message.success && message.config) {
            // ä½¿ç”¨æ–°çš„é…ç½®ç»“æ„æ¢å¤ UI çŠ¶æ€
            updateModelConfigDisplay(message.config);
          } else {
            console.log('[PANEL] æœªæ‰¾åˆ°å·²ä¿å­˜çš„æ¨¡å‹é…ç½®ï¼Œä½¿ç”¨é»˜è®¤');
            // ä½¿ç”¨é»˜è®¤é…ç½®
            updateModelConfigDisplay(null);
          }
          break;
        case 'modelConfigSaved':
          // æ¨¡å‹é…ç½®ä¿å­˜ç»“æœ
          const modelStatusDiv = document.getElementById('model-config-status');
          if (message.success) {
            modelStatusDiv.className = 'config-status success';
            modelStatusDiv.textContent = `âœ… æ¨¡å‹é…ç½®å·²ä¿å­˜: ${message.config?.provider} / ${message.config?.model || ''}`;
            // æ›´æ–°æ˜¾ç¤º
            if (message.config) {
              updateModelConfigDisplay(message.config);
            }
            // 5ç§’åæ¸…é™¤çŠ¶æ€
            setTimeout(() => {
              modelStatusDiv.className = 'config-status';
              modelStatusDiv.textContent = '';
            }, 5000);
          } else {
            modelStatusDiv.className = 'config-status error';
            modelStatusDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + (message.error || 'æœªçŸ¥é”™è¯¯');
          }
          break;
        // {{ AURA: Add - å¥—é¤ä¿¡æ¯æ¶ˆæ¯å¤„ç† }}
        case 'quotaInfoLoaded':
          console.log('[PANEL] æ”¶åˆ°å¥—é¤ä¿¡æ¯:', message);
          updateQuotaDisplay(message);
          break;
      }
    });

    // æ£€æµ‹VIPç‰ˆæœ¬å¹¶æ§åˆ¶é¢æ¿æ˜¾ç¤º
    let initRetryCount = 0;
    let initTimer = null;

    function checkVipVersionAndShowPanels() {
      // ç«‹å³å‘é€ç¬¬ä¸€æ¬¡è¯·æ±‚
      sendInitMessages();

      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
      if (initTimer) clearInterval(initTimer);

      // å¯åŠ¨é‡è¯•å¾ªç¯ (æ¯1ç§’é‡è¯•ä¸€æ¬¡ï¼Œæœ€å¤š5æ¬¡)
      initTimer = setInterval(() => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–æˆåŠŸ (é€šè¿‡æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬æ˜¯å¦å·²æ›´æ–°)
        const isInitialized = document.getElementById('extension-version').textContent !== 'æœªçŸ¥';

        if (isInitialized) {
          console.log('[PANEL] âœ… åˆå§‹åŒ–æˆåŠŸï¼Œåœæ­¢é‡è¯•');
          clearInterval(initTimer);
          return;
        }

        if (initRetryCount >= 5) {
          console.log('[PANEL] âš ï¸ åˆå§‹åŒ–é‡è¯•æ¬¡æ•°è€—å°½ï¼Œåœæ­¢é‡è¯•');
          clearInterval(initTimer);
          return;
        }

        initRetryCount++;
        console.log(`[PANEL] â³ æœªæ”¶åˆ°å“åº”ï¼Œæ­£åœ¨é‡è¯•åˆå§‹åŒ– (${initRetryCount}/5)...`);
        sendInitMessages();
      }, 1000);
    }

    function sendInitMessages() {
      vscode.postMessage({ command: 'getExtensionInfo' });
      vscode.postMessage({ command: 'requestSystemInfo' });
    }

    // ========== æ¨¡å‹é…ç½®ç›¸å…³ ==========
    // {{ AURA: Modify - ç¡¬ç¼–ç  Kiro Provider é…ç½®ï¼Œç®€åŒ–ç•Œé¢ }}

    // ç¡¬ç¼–ç é»˜è®¤é…ç½®
    const DEFAULT_PROVIDER = 'Kiro';
    const DEFAULT_BASE_URL = 'https://newapi.stonefancyx.com';

    // æ¨¡å‹æ˜¾ç¤ºåç§°æ˜ å°„ï¼ˆæ˜¾ç¤ºåç§° -> å®é™…æ¨¡å‹åç§°ï¼‰
    const MODEL_DISPLAY_MAP = {
      'Claude Opus 4.5': 'kiro-claude-opus-4-5-agentic',
      'Sonnet 4.5': 'kiro-claude-sonnet-4-5-agentic',
      'Sonnet 4': 'kiro-claude-sonnet-4-agentic',
      'Haiku 4.5': 'kiro-claude-haiku-4-5-agentic'
    };

    // åå‘æ˜ å°„ï¼ˆå®é™…æ¨¡å‹åç§° -> æ˜¾ç¤ºåç§°ï¼‰
    const MODEL_REVERSE_MAP = {
      'kiro-claude-opus-4-5-agentic': 'Claude Opus 4.5',
      'kiro-claude-sonnet-4-5-agentic': 'Sonnet 4.5',
      'kiro-claude-sonnet-4-agentic': 'Sonnet 4',
      'kiro-claude-haiku-4-5-agentic': 'Haiku 4.5'
    };

    // Kiro Provider çš„æ¨¡å‹åˆ—è¡¨
    const KIRO_MODELS = [
      'kiro-claude-opus-4-5-agentic',
      'kiro-claude-sonnet-4-5-agentic',
      'kiro-claude-sonnet-4-agentic',
      'kiro-claude-haiku-4-5-agentic'
    ];

    // ä¿ç•™ PROVIDERS å˜é‡ä»¥å…¼å®¹ç°æœ‰ä»£ç 
    let PROVIDERS = {
      'Kiro': {
        name: 'Kiro',
        base_url: DEFAULT_BASE_URL,
        models: KIRO_MODELS
      }
    };

    // å½“å‰é€‰ä¸­çš„ provider å’Œ model
    let currentProvider = DEFAULT_PROVIDER;
    let currentModel = KIRO_MODELS[0]; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹

    // {{ AURA: Modify - ç®€åŒ– Provider åˆå§‹åŒ–ï¼Œç¡¬ç¼–ç ä¸º Kiro }}
    function initProviderSelect() {
      // Provider å·²åœ¨ HTML ä¸­ç¡¬ç¼–ç ä¸º Kiroï¼Œæ— éœ€åŠ¨æ€ç”Ÿæˆ
      const providerSelect = document.getElementById('provider-select');
      providerSelect.value = DEFAULT_PROVIDER;
      currentProvider = DEFAULT_PROVIDER;
      document.getElementById('current-provider').textContent = 'Kiro';
    }

    // æ›´æ–° Provider æ˜¾ç¤ºä¿¡æ¯ (ç®€åŒ–ç‰ˆ)
    function updateProviderDisplay(providerKey) {
      currentProvider = DEFAULT_PROVIDER;
      document.getElementById('current-provider').textContent = 'Kiro';
    }

    // {{ AURA: Modify - æ¨¡å‹ä¸‹æ‹‰æ¡†å·²åœ¨ HTML ä¸­ç¡¬ç¼–ç ï¼Œæ­¤å‡½æ•°ä¿ç•™å…¼å®¹æ€§ }}
    function updateModelSelect(providerKey) {
      // æ¨¡å‹åˆ—è¡¨å·²åœ¨ HTML ä¸­ç¡¬ç¼–ç ï¼Œæ— éœ€åŠ¨æ€ç”Ÿæˆ
      // ä»…é‡ç½®å½“å‰æ¨¡å‹æ˜¾ç¤º
      const modelSelect = document.getElementById('model-select');
      if (modelSelect.value) {
        currentModel = modelSelect.value;
        const displayName = MODEL_REVERSE_MAP[currentModel] || currentModel;
        document.getElementById('current-model').textContent = displayName;
      }
    }

    // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† (ç®€åŒ–ç‰ˆ)
    function initModelSelect() {
      const modelSelect = document.getElementById('model-select');

      // Model é€‰æ‹©äº‹ä»¶ - æ›´æ–°å½“å‰æ¨¡å‹æ˜¾ç¤º
      modelSelect.addEventListener('change', function () {
        const selectedModel = this.value;
        if (selectedModel) {
          currentModel = selectedModel;
          const displayName = MODEL_REVERSE_MAP[selectedModel] || selectedModel;
          document.getElementById('current-model').textContent = displayName;
        }
      });

      // åˆå§‹åŒ– Providerï¼ˆç¡¬ç¼–ç ä¸º Kiroï¼‰
      initProviderSelect();

      // è®¾ç½®é»˜è®¤ Base URL
      document.getElementById('base-url-input').value = DEFAULT_BASE_URL;

      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
      if (modelSelect.options.length > 1) {
        modelSelect.selectedIndex = 1; // è·³è¿‡ "-- é€‰æ‹©æ¨¡å‹ --" å ä½ç¬¦
        currentModel = modelSelect.value;
        const displayName = MODEL_REVERSE_MAP[currentModel] || currentModel;
        document.getElementById('current-model').textContent = displayName;
      }
    }

    // åˆ·æ–°æ¨¡å‹é…ç½®æ˜¾ç¤º
    function refreshModelConfig() {
      console.log('[PANEL] åˆ·æ–°æ¨¡å‹é…ç½®...');
      vscode.postMessage({
        command: 'getModelConfig'
      });
    }
    function toggleApiKeyVisibility() {
      const input = document.getElementById('api-key-input');
      const btn = document.getElementById('toggle-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'ğŸ”’'; // Click to hide
      } else {
        input.type = 'password';
        btn.textContent = 'ğŸ‘ï¸'; // Click to show
      }
    }

    /**
     * {{ AURA: Modify - ç®€åŒ–æ¨¡å‹é…ç½®æ˜¾ç¤ºå‡½æ•°ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼ }}
     */
    function updateModelConfigDisplay(config) {
      console.log('[PANEL] æ›´æ–°æ¨¡å‹é…ç½®æ˜¾ç¤º:', config);

      // ä½¿ç”¨ç¡¬ç¼–ç çš„ Kiro Provider
      currentProvider = DEFAULT_PROVIDER;
      document.getElementById('provider-select').value = DEFAULT_PROVIDER;
      document.getElementById('current-provider').textContent = 'Kiro';

      // è®¾ç½®é»˜è®¤ Base URL
      document.getElementById('base-url-input').value = DEFAULT_BASE_URL;

      // æ¢å¤ API Keyï¼ˆå¦‚æœé…ç½®ä¸­æœ‰ï¼‰
      if (config && config.api_key) {
        document.getElementById('api-key-input').value = config.api_key;
      }

      // è®¾ç½®æ¨¡å‹
      const modelSelect = document.getElementById('model-select');
      let targetModel = KIRO_MODELS[0]; // é»˜è®¤ç¬¬ä¸€ä¸ªæ¨¡å‹

      if (config && config.model && KIRO_MODELS.includes(config.model)) {
        targetModel = config.model;
      }

      // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨äºåˆ—è¡¨ä¸­
      const optionExists = Array.from(modelSelect.options).some(opt => opt.value === targetModel);
      if (optionExists) {
        modelSelect.value = targetModel;
        currentModel = targetModel;
        const displayName = MODEL_REVERSE_MAP[targetModel] || targetModel;
        document.getElementById('current-model').textContent = displayName;
      } else {
        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
        if (modelSelect.options.length > 1) {
          modelSelect.selectedIndex = 1;
          currentModel = modelSelect.value;
          const displayName = MODEL_REVERSE_MAP[currentModel] || currentModel;
          document.getElementById('current-model').textContent = displayName;
        }
      }

      console.log(`[PANEL] æ¨¡å‹é…ç½® UI å·²æ›´æ–°: ${currentProvider} / ${currentModel}`);
    }

    // æ ¹æ® provider å’Œ model æŸ¥æ‰¾é…ç½® (å…¼å®¹æ—§æ¥å£)
    function findModelConfigByProviderAndModel(providerKey, modelName) {
      if (!providerKey || !modelName) return null;
      const provider = PROVIDERS[providerKey];
      if (provider && provider.models.includes(modelName)) {
        return {
          provider: providerKey,
          model: modelName
        };
      }
      return null;
    }

    // {{ AURA: Modify - ç®€åŒ–åº”ç”¨é…ç½®å‡½æ•°ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼ }}
    function applyModelConfig() {
      const modelSelect = document.getElementById('model-select');
      const statusDiv = document.getElementById('model-config-status');
      const apiKeyInput = document.getElementById('api-key-input');

      const selectedModel = modelSelect.value;
      const apiKey = apiKeyInput.value.trim();

      // åªéªŒè¯ API Key å’Œæ¨¡å‹é€‰æ‹©
      if (!apiKey) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·å…ˆè¾“å…¥ API Key';
        return;
      }

      if (!selectedModel) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹';
        return;
      }

      // ä½¿ç”¨ç¡¬ç¼–ç çš„ Provider å’Œ Base URL
      const config = {
        provider: DEFAULT_PROVIDER,
        model: selectedModel,
        base_url: DEFAULT_BASE_URL,
        api_key: apiKey
      };

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ åº”ç”¨é…ç½®ä¸­...';

      vscode.postMessage({
        command: 'saveModelConfig',
        config: config
      });
    }

    // {{ AURA: Add - å¥—é¤ä¿¡æ¯ç›¸å…³å‡½æ•° }}
    // åˆ·æ–°å¥—é¤ä¿¡æ¯
    function refreshQuotaInfo() {
      console.log('[PANEL] åˆ·æ–°å¥—é¤ä¿¡æ¯...');
      document.getElementById('quota-available').innerHTML = '<span class="loading">â³ åŠ è½½ä¸­...</span>';
      document.getElementById('quota-status').textContent = '';

      vscode.postMessage({
        command: 'refreshQuotaInfo'
      });
    }

    // æ›´æ–°å¥—é¤ä¿¡æ¯æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºä½™é¢ï¼‰
    function updateQuotaDisplay(quotaInfo) {
      console.log('[PANEL] æ›´æ–°å¥—é¤ä¿¡æ¯æ˜¾ç¤º:', quotaInfo);
      const availableEl = document.getElementById('quota-available');
      const expiresEl = document.getElementById('quota-expires');
      const statusEl = document.getElementById('quota-status');

      if (quotaInfo && quotaInfo.success) {
        const data = quotaInfo.data;
        // {{ AURA: Modify - æ ¼å¼åŒ–ä½™é¢ï¼ˆé™¤ä»¥250ï¼Œæ˜¾ç¤ºæ•´æ•°ï¼‰ }}
        const available = Math.floor(data.total_available / 100);

        availableEl.textContent = `${available}`;
        availableEl.style.color = parseFloat(available) > 500 ? 'var(--vscode-testing-iconPassed)' :
                                   parseFloat(available) > 50 ? 'var(--vscode-editorWarning-foreground)' :
                                   'var(--vscode-errorForeground)';

        // æ ¼å¼åŒ–è¿‡æœŸæ—¶é—´
        if (data.expires_at) {
          const expiresDate = new Date(data.expires_at * 1000);
          expiresEl.textContent = expiresDate.toLocaleString();
        } else {
          expiresEl.textContent = 'æ°¸ä¹…æœ‰æ•ˆ';
        }

        statusEl.className = 'config-status success';
        statusEl.textContent = 'âœ… å¥—é¤ä¿¡æ¯å·²æ›´æ–°';
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'config-status';
        }, 3000);
      } else {
        availableEl.innerHTML = '<span class="error">è·å–å¤±è´¥</span>';
        expiresEl.textContent = '-';
        statusEl.className = 'config-status warning';
        statusEl.textContent = quotaInfo?.error || 'âš ï¸ æ— æ³•è·å–å¥—é¤ä¿¡æ¯';
      }
    }

    // æ˜¾ç¤ºæˆ–éšè—VIPä¸“å±åŠŸèƒ½
    function toggleVipFeatures(isVip) {
      const vipElements = document.querySelectorAll('.vip-only');
      vipElements.forEach(element => {
        if (isVip) {
          element.style.display = 'block';
        } else {
          element.style.display = 'none';
        }
      });

      console.log(`[PANEL] æ‰€æœ‰åŠŸèƒ½${isVip ? 'å·²å¯ç”¨' : 'å·²éšè—'}`);
    }

    // ç›´æ¥è¯»å–å½“å‰æ’ä»¶çš„package.jsonè·å–å®‰è£…æ—¶é—´
    function loadInstallTimeFromPackageJson() {
      vscode.postMessage({
        command: 'getInstallTimeFromPackageJson'
      });
    }

    // å­—ç¬¦ä¸²è§£ç å‡½æ•° - é˜²æ­¢é™æ€åˆ†æ
    const decode = (str) => atob(str);
    const hex2str = (hex) => decodeURIComponent(hex.replace(/\s+/g, '').replace(/[0-9a-f]{2}/g, '%$&'));

    // ç¼–ç çš„çŠ¶æ€å­—ç¬¦ä¸²
    const STATUS_STRINGS = {
      ACTIVATED: decode('YWN0aXZhdGVk'), // 'activated'
      PENDING: decode('cGVuZGluZw=='), // 'pending'
      EXPIRED: decode('ZXhwaXJlZA=='), // 'expired'
      NOT_ACTIVATED: decode('bm90X2FjdGl2YXRlZA==') // 'not_activated'
    };

    // å®šæ—¶å™¨å˜é‡
    let statusUpdateTimer = null;

    // å¯åŠ¨çŠ¶æ€å®šæ—¶æ›´æ–°ï¼ˆä»…åœ¨å¾…æ¿€æ´»çŠ¶æ€ä¸‹ï¼‰
    function startStatusTimer() {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (statusUpdateTimer) {
        clearInterval(statusUpdateTimer);
      }

      // æ¯10ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
      statusUpdateTimer = setInterval(() => {
        console.log('[PANEL] å®šæ—¶æ›´æ–°æ¿€æ´»çŠ¶æ€...');
        refreshActivationStatus();
      }, 10000); // 10ç§’

      console.log('[PANEL] çŠ¶æ€å®šæ—¶å™¨å·²å¯åŠ¨ (æ¯10ç§’æ›´æ–°)');
    }

    // åœæ­¢çŠ¶æ€å®šæ—¶æ›´æ–°
    function stopStatusTimer() {
      if (statusUpdateTimer) {
        clearInterval(statusUpdateTimer);
        statusUpdateTimer = null;
        console.log('[PANEL] çŠ¶æ€å®šæ—¶å™¨å·²åœæ­¢');
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè¯·æ±‚ç³»ç»Ÿä¿¡æ¯å’Œç§¯åˆ†ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[PANEL] ğŸ” DOM loaded, starting initialization...');
      console.log('[PANEL] å½“å‰æ—¶é—´:', new Date().toISOString());

      vscode.postMessage({
        command: 'requestSystemInfo'
      });

      // æ£€æµ‹VIPç‰ˆæœ¬
      checkVipVersionAndShowPanels();

      // ç«‹å³è§¦å‘æ¿€æ´»çŠ¶æ€æ£€æŸ¥ï¼ˆæ·»åŠ è¯Šæ–­ï¼‰
      console.log('[PANEL] ğŸš€ ç«‹å³è§¦å‘æ¿€æ´»çŠ¶æ€æ£€æŸ¥...');
      refreshActivationStatus();

      // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨å¹¶åŠ è½½å½“å‰é…ç½®
      console.log('[PANEL] ğŸ¤– åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨...');
      initModelSelect();
      refreshModelConfig();

      // VIPä¸“å±åŠŸèƒ½ï¼ˆå°†åœ¨æ”¶åˆ°æ‰©å±•ä¿¡æ¯åå†³å®šæ˜¯å¦åŠ è½½ï¼‰
      // loadCurrentToken();
      // refreshBalance();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function () {
      stopStatusTimer();
    });
  </script>
</body>

</html>